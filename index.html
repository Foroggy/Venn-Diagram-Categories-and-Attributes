<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi Venn Diagram</title>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/venn.js@0.2.20/venn.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }
    table {
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      padding: 6px 10px;
      border: 1px solid #ccc;
    }
    .button {
      padding: 10px 20px;
      font-size: 16px;
      margin-right: 10px;
    }
    #container {
      display: flex;
      align-items: flex-start;
    }
    #titleList {
      margin-right: 20px;
      min-width: 200px;
    }
    #titleList div {
      font-weight: bold;
      margin-bottom: 8px;
      cursor: pointer;
    }
    #venn {
      width: 1200px;
      height: 1000px;
      position: relative;
    }
    .label {
      font-size: 12px;
      font-weight: bold;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <h2>Multi Venn Diagram</h2>
  <p>Enter Categories (single titles) and Attributes (comma-separated if multiple):</p>
  <table id="inputTable">
    <thead>
      <tr><th>Categories</th><th>Attributes</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button class="button" onclick="addRow()">+ Add Row</button>
  <button class="button" onclick="generateVenn()">Generate Diagram</button>
  <button class="button" onclick="toggleLines()">Toggle Lines</button>

  <div id="container">
    <div id="titleList"></div>
    <div id="venn"></div>
  </div>

  <script>
    const tableBody = document.querySelector("#inputTable tbody");
    let categoryCenters = {};
    let showLines = false;

    function addRow() {
      const row = document.createElement("tr");
      row.innerHTML = `<td><input type="text"></td><td><input type="text"></td>`;
      tableBody.appendChild(row);
    }
    for (let i = 0; i < 15; i++) addRow();

    function generateVenn() {
      const colorMap = {};
      const rows = tableBody.querySelectorAll("tr");
      const categoryMap = {};
      let gapCount = 0;

      rows.forEach(row => {
        const sf = row.children[0].querySelector("input").value.trim();
        const centers = row.children[1].querySelector("input").value.trim().split(/,\s*/).filter(Boolean);

        if (!sf) return;
        if (centers.length === 0) {
          gapCount++;
        } else {
          centers.forEach(center => {
            if (!categoryMap[sf]) categoryMap[sf] = new Set();
            categoryMap[sf].add(center);
          });
        }
      });

      const categoryKeys = Object.keys(categoryMap);
      const sets = categoryKeys.map(category => ({ sets: [category], size: categoryMap[category].size }));

      for (let i = 0; i < categoryKeys.length; i++) {
        for (let j = i + 1; j < categoryKeys.length; j++) {
          const a = categoryMap[categoryKeys[i]];
          const b = categoryMap[categoryKeys[j]];
          const overlap = [...a].filter(x => b.has(x)).length;
          if (overlap > 0) {
            sets.push({ sets: [categoryKeys[i], categoryKeys[j]], size: overlap });
          }
        }
      }

      if (gapCount > 0) {
        sets.push({ sets: ["GAP"], size: gapCount });
      }

      const chart = venn.VennDiagram().width(1200).height(1000);
      d3.select("#venn").datum(sets).call(chart);

      // Store fill colors
      d3.selectAll(".venn-area")
        .each(function(d) {
          const path = d3.select(this).select("path");
          const fill = path.style("fill");
          if (d.sets.length === 1) {
            colorMap[d.sets[0]] = fill;
          }
        });

      // Style text
      d3.selectAll("#venn text.label")
        .style("font-weight", "bold")
        .style("font-size", "12px")
        .each(function(d) {
          if (d.sets.length === 1 && colorMap[d.sets[0]]) {
            const baseColor = d3.color(colorMap[d.sets[0]]);
            const darker = baseColor ? baseColor.darker(2).toString() : "black";
            d3.select(this).style("fill", darker);
          }
        })
        .raise();

      d3.selectAll(".venn-area path")
        .style("stroke", "#333")
        .style("stroke-width", 1.5);

      // Special styling for GAP
      d3.selectAll(".venn-area")
        .filter(d => d.sets.includes("GAP"))
        .style("fill", "#f77")
        .style("stroke", "#c00")
        .style("stroke-width", 2);

      // Store center positions for each category
      categoryCenters = {};
      d3.selectAll(".venn-area")
        .filter(d => d.sets.length === 1)
        .each(function(d) {
          const circle = d3.select(this).select("path").node();
          if (!circle) return;
          const bbox = circle.getBBox();
          categoryCenters[d.sets[0]] = {
            x: bbox.x + bbox.width / 2,
            y: bbox.y + bbox.height / 2
          };
        });

      // Generate list of category titles on the left
      const listDiv = document.getElementById("titleList");
      listDiv.innerHTML = "";
      categoryKeys.forEach(cat => {
        const div = document.createElement("div");
        div.textContent = cat;
        div.style.color = colorMap[cat] || "#000";
        listDiv.appendChild(div);
      });
    }

    function toggleLines() {
      showLines = !showLines;
      const svg = d3.select("#venn svg");
      svg.selectAll(".title-line").remove();

      if (showLines) {
        const listItems = document.querySelectorAll("#titleList div");
        listItems.forEach((div, idx) => {
          const cat = div.textContent;
          if (categoryCenters[cat]) {
            const labelX = -200; // left of diagram
            const labelY = idx * 20 + 20; // space out

            // Add line from label to circle center
            svg.append("line")
              .attr("class", "title-line")
              .attr("x1", labelX + 200) // right edge of label area
              .attr("y1", labelY)
              .attr("x2", categoryCenters[cat].x)
              .attr("y2", categoryCenters[cat].y)
              .attr("stroke", "#444")
              .attr("stroke-width", 1);
          }
        });
      }
    }
  </script>
</body>
</html>
